# Economic Simulation Details: Advanced Mechanics

本ドキュメントでは、経済シミュレーションエンジンの詳細なアルゴリズムとロジック、特に「生産能力（Capacity）」「需要セグメント（Demand Segmentation）」「在庫と価格サイクル（Inventory & Pricing Cycles）」について記述します。
これらのメカニズムにより、単なる乱数ではない、プレイヤーが予測・分析可能な市場データが生成されます。

## 1. 生産能力と設備投資 (Production Capacity & CapEx)

企業は無限に商品を生産できるわけではなく、物理的な生産能力の限界を持っています。この制約が、企業の成長機会（設備投資）とリスク（稼働率低下）を生み出します。

### 1.1 最大生産量 (Max Capacity)
*   **定義**: 企業が1四半期（14日間）に生産できる製品の最大数量。
*   **ロジック**:
    *   `Max_Capacity` は各企業に設定された固定値（整数）です。
    *   `需要 (Demand) > Max_Capacity` となった場合、実際の `販売数量 (Sales_Volume)` は `Max_Capacity` で頭打ちとなります。
    *   **機会損失 (Opportunity Loss)**: `需要 - Max_Capacity` の差分は、本来得られたはずの売上の損失を表します。

### 1.2 設備投資ロジック (Capital Expenditure / CapEx)
*   **トリガー**: `需要 > Max_Capacity` の状態がX期間連続（または特定の閾値、例: 110%以上）で続いた場合、企業のAI経営陣は拡張投資を決定します。
*   **効果**:
    1.  **即時のコスト**: 当期または翌期の決算で巨額のキャッシュアウト（`CapEx`）が発生し、一時的に `純利益 (Net_Income)` を圧迫します。
    2.  **遅延した恩恵**: 建設期間（例: 1-2四半期）を経て、`Max_Capacity` が大幅に増加（例: +20%）します。
*   **市場シグナル**: CapExの発表は、長期的には「成長」への期待（強気シグナル）ですが、短期的にはキャッシュ減少による減配リスク（弱気シグナル）となります。

### 1.3 稼働率と固定費 (Utilization Rate & Fixed Costs)
*   **定義**: `稼働率 (Utilization_Rate) = 実際の生産量 / Max_Capacity`
*   **固定費メカニズム**:
    *   企業は生産量に関わらず、工場維持のための高い **固定費 (Fixed Costs)**（人件費、減価償却費）を負担します。
    *   **低稼働率**: 需要が落ち込み稼働率が低下（例: 70%未満）すると、製品1個あたりの固定費負担が激増し、利益率（Margin）が急速に悪化します。
    *   **高稼働率**: 稼働率が100%に近づくにつれ、固定費が多くの製品に分散され、利益率が最大化されます（営業レバレッジ）。

---

## 2. 需要セグメント (Demand Segmentation)

需要はランダムではなく、3つの異なる顧客セグメントによって生成され、それぞれ独自のロジックで動きます。

### 2.1 B2B需要 (Business-to-Business)
*   **ロジック**: サプライチェーンの下流企業の生産計画に連動します。
*   **計算式**:
    *   `上流企業の需要 = Sum(下流企業iの生産計画 * 必要投入量i)`
*   **例**:
    *   **Silicon Dragon（半導体）** の需要は、**OmniCorp（AI）** や **CyberLife（インプラント）** の次期生産計画から逆算されて自動的に決定されます。
    *   OmniCorpがサーバー増設（CapEx）を発表すれば、Silicon Dragonには確実な特需が発生します。

### 2.2 B2C需要 (Business-to-Consumer)
*   **ロジック**: 対象となる国家のマクロ経済指標（GDP成長率、失業率、インフレ率）に依存します。
*   **要因**:
    *   **GDP成長率**: 消費のベースライン。
    *   **失業率**: 逆相関。失業率が上がると、高級品（例: **Stardust Luxury**）の需要は激減します。
    *   **消費者信頼感指数**: 裁量的支出に影響します。
*   **弾力性 (Elasticity)**:
    *   **必需品 (Red Ox Food)**: 非弾力的。不景気でも需要は底堅い。
    *   **贅沢品 (Stardust Luxury)**: 弾力的。景気後退時に真っ先に需要が消滅する。

### 2.3 B2G需要 (Government Procurement)
*   **ロジック**: 国家AIの政策イベントや地政学リスクによって突発的に発生します。
*   **トリガー**:
    *   **紛争・緊張**: **Iron Fist Armaments（兵器）** や **Titan Energy（燃料）** への需要急増。
    *   **公共事業**: インフラ整備による **Boros（鉄鋼）** や **Arcadia（テック）** への発注。
*   **特徴**: 巨大かつ確定した注文（Contract Wins）であり、次期決算の好調が約束されます。

---

## 3. 在庫と価格サイクル (Inventory & Pricing Cycles)

供給（生産）と需要のバランスが崩れることで在庫サイクルが生まれ、インフレやデフレを引き起こします。

### 3.1 在庫の蓄積 (Inventory Accumulation)
*   **ロジック**: `期末在庫 = 期首在庫 + 生産量 - 販売量`
*   **売れ残り**: `生産量 > 販売量` の場合、在庫が積み上がります。
*   **維持コスト**: 在庫を持つだけで保管費や保険料が発生し、利益を圧迫します。

### 3.2 値引き販売 (Discounting / Deflationary Pressure)
*   **トリガー**: `在庫 / 週次販売量 > 閾値`（例: 在庫が4週間分を超過）となった場合。
*   **アクション**: 企業は在庫処分のため、製品価格の値下げ（`Price_Discount`）を行います。
*   **財務への影響**: 売上数量は回復しても、**粗利益率 (Gross Margin)** が低下します。
*   **プレイヤーへのシグナル**: 四半期レポートで在庫レベルの上昇を確認することは、次期の利益率低下を予測する先行指標となります。

### 3.3 値上げ (Price Hikes / Inflationary Pressure)
*   **トリガー**: `在庫` がほぼゼロ かつ `需要 > Max_Capacity`（品薄状態）の場合。
*   **アクション**: 企業は強気に製品価格の値上げ（`Price_Hike`）を行い、利益を最大化しようとします。
*   **マクロへの波及**:
    *   エネルギーや食料など主要セクターでの値上げが連鎖することで、世界設定の **CPI (消費者物価指数)** が上昇します。
    *   CPI上昇は中央銀行による **利上げ (Interest Rate Hike)** を引き起こし、株式市場全体を冷やす可能性があります。

---

## 4. プレイヤーの戦略と分析 (Player Strategy)

これらのメカニズムにより、チャート分析だけでなくファンダメンタルズ分析が可能になります。

*   **先行指標を探す**:
    *   「San Verdeの干ばつニュース」→ 穀物収穫減 → **Red Ox Food** の調達コスト増を予測。
    *   「政府の軍事パレード計画」→ **Iron Fist Armaments** の決算前に仕込む。
*   **決算レポートの深読み**:
    *   「工場稼働率: 98%」というテキストがあれば、これ以上の売上増はCapExがない限り不可能（成長の天井）。
    *   「在庫増加」の記述は、次期の値下げと利益率低下の警告。
*   **サプライチェーン・トレード**:
    *   川下の **OmniCorp** が好調な受注を発表したら、そのサプライヤーである **Silicon Dragon** を即座に買う。

---

## 5. Corporate Trading & Supply Chain Mechanism

企業は静的なオブジェクトではなく、Botとして市場に参加し、自律的に経済活動を行うエージェントです。
`init.sql` で定義された `production_recipes` と `production_inputs` に基づき、以下のサイクルで活動します。

### 5.1 Corporate Bots (企業Bot)
*   **アカウント**: 各企業は `users` テーブルに紐付くBotアカウントを持っています（`companies.user_id`）。
*   **資産管理**: 一般プレイヤーと同様に、`currency_balances`（現金）と `asset_balances`（在庫）を持ちます。
*   **行動原理**: 企業の目的は「利益の最大化」と「継続的な生産」です。在庫切れや資金不足を回避しつつ、高値で製品を売ることを目指します。

### 5.2 Procurement (仕入れ)
生産に必要な原材料（Inputs）を市場から調達するプロセスです。

1.  **所要量計算 (Requirement Calculation)**:
    *   目標生産量（Target Production）に基づき、必要な原材料の数量を計算します。
    *   `必要量 = 目標生産量 × レシピInput係数 - 現在の原材料在庫`
2.  **注文実行 (Order Placement)**:
    *   不足している原材料に対し、市場（Order Book）に「買い注文（Buy Order）」を出します。
    *   **注文タイプ**: 基本的に「指値注文（Limit Order）」を使用しますが、在庫が危機的に少ない場合は「成行注文（Market Order）」で緊急調達します。
    *   **予算制約**: 企業の現金残高（Cash Balance）の範囲内でのみ発注可能です。資金不足時は目標生産量を下方修正します。

### 5.3 Production (生産)
原材料を消費して製品（Output）を生み出すプロセスです。シミュレーションの負荷軽減のため、日次バッチ処理（Daily Batch）として実行されます。

1.  **Input消費**:
    *   `production_inputs` テーブルの定義に従い、`asset_balances` から原材料を減少させます。
    *   原材料が不足している場合、生産可能な最大数量のみが生産されます。
2.  **Output生成**:
    *   `production_recipes` テーブルの定義に従い、`asset_balances` に製品（Commodity Asset）を追加します。
    *   この際、`companies.max_production_capacity` の上限を超えて生産することはできません。
3.  **コスト計算**:
    *   消費した原材料の取得価格（移動平均法）と固定費を合算し、製品の製造原価（COGS）として記録します。

### 5.4 Sales (販売)
生産された製品を市場で現金化するプロセスです。

1.  **在庫評価**:
    *   現在の製品在庫レベルを確認します。
2.  **売り注文 (Sell Order)**:
    *   生産された製品を市場（Order Book）に「売り注文」として出します。
    *   **価格戦略 (Dynamic Pricing)**:
        *   **在庫過多**: 前回の販売価格より `値下げ (Discount)` して、早期の現金化を優先します。
        *   **在庫不足**: 前回の販売価格より `値上げ (Premium)` して、利益率を改善します。
        *   **市場追随**: 他のプレイヤーやBotの注文状況（板情報）を監視し、競争力のある価格を提示します。

### 5.5 Profit & Loss (損益)
*   **売上 (Revenue)**: 製品の販売によって得られた現金。
*   **費用 (Expenses)**: 原材料購入費 + 固定費（人件費・設備維持費）。
*   **純利益 (Net Income)**: `売上 - 費用`。これが四半期決算で報告され、配当の原資となります。
