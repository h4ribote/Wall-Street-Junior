# マージンコール & 強制決済設計仕様書 (Isolated Margin Model)

## 1. 概要 (Overview)

Paper Street では、リスク管理モデルとして**「分離マージン (Isolated Margin)」**方式を採用します。
各ポジションは独立した証拠金（担保）を持ち、あるポジションで強制ロスカットが発生しても、**ウォレット内の他の資金や、別のポジションには波及しません**。

### このモデルのメリット

* **リスクの限定**: 1つの無謀なトレードで全財産を失うリスクがない。
* **戦略の明確化**: ポジションごとに「このトレードには最大これだけのリスクを負う」という設定が可能。


## 2. 証拠金管理の仕組み (Margin Management)

### 2.1. 新規注文時の証拠金拘束

プレイヤーがレバレッジをかけて注文を出す際、以下の計算式でウォレットから資金（Currency Balance）が拘束され、ポジション固有の証拠金として割り当てられます。

* **必要証拠金 (Initial Margin)** = `(注文価格 × 数量) / レバレッジ`

**例**: 1株 100 ARC の銘柄を 10株、レバレッジ 5倍 で買う場合
* 取引総額: 1,000 ARC
* 必要証拠金: 1,000 / 5 = **200 ARC**

ユーザーのウォレットから **200 ARC** が引かれ、このポジションの `margin_used` に設定されます。

### 2.2. 証拠金の追加 (Margin Top-up)

* **機能**: プレイヤーは、ロスカットを防ぐために、既存のポジションに対してウォレットから追加の資金を注入（Add Margin）することができます。
* **効果**: `margin_used`（分母）が増えるため、損失率（%）が低下し、ロスカットまでの距離が遠のきます。


## 3. ロスカット・ロジック (Liquidation Logic)

ユーザーの指定に基づき、**「証拠金に対する損失の割合」**を基準とします。

### 3.1. 計算式 (The Formula)

ロスカット判定は以下の比率（Loss Ratio）を用いて行います。

* **含み損 (Unrealized Loss)**: `|Current Price - Entry Price| * Quantity`
* ※利益が出ている場合は0扱い（ロスカット対象外）

* **累積金利 (Accumulated Fees)**: DLIシステムに基づき、時間経過とともに徴収される金利・貸出料の合計。これも「損失」の一部として加算されます。

### 3.2. 発動条件 (Trigger)

* **閾値**: Loss Ratio **≧ 75%**
* **意味**: 「割り当てた証拠金の4分の3を失った時点」で強制終了となります。残り25%はペナルティおよびバッファとして扱われます。

**例**: 証拠金 200 ARC のポジション
* 株価下落により含み損が **-140 ARC**
* DLI金利による支払いが累積 **-10 ARC**
* 合計損失: **150 ARC**
* 損失率: 150 / 200 = **75%** → **ロスカット発動**


## 4. DLI金利との相互作用 (Interaction with DLI)

[DUAL_LIQUIDITY_INVENTORY](./DUAL_LIQUIDITY_INVENTORY.md) で定義された変動金利は、以下のように処理されます。

1. **証拠金からの控除**:
* 金利（Borrow Rate / Short Fee）は、ウォレット残高からではなく、**累積損失として計算式に加算**する形で処理します。

2. **「金利負け」によるロスカット**:
* 株価が全く動かなくても、高金利（在庫枯渇時）の状態が続けば、累積金利が増加し続け、いずれ損失率75%に達して強制決済されます。
* これにより、流動性を独占し続ける「放置ボット」や「塩漬けプレイヤー」を市場から排除し、在庫を循環させます。


## 5. 強制決済プロセス (Execution Process)

### Step 1: 監視 (Monitoring)

* **Liquidation Bot** が定期的に（または価格更新イベント駆動で）全ポジションの損失率を計算します。

### Step 2: 執行 (Execution)

損失率が75%を超えたポジションに対し、以下の処理を即座に実行します。

1. **成行決済 (Market Close)**: ポジションの全数量を成行注文で決済します。
2. **残余金の精算**:
* 決済後の残った証拠金から、10%を **強制決済手数料 (Liquidation Fee)** として徴収します。
* 残り: ユーザーのウォレットに返還します。

### Step 3: 通知 (Notification)

* ユーザーに対し、「ポジション #12345 (OMNI) が強制決済されました。損失率: 75.2%」という通知を送ります。
