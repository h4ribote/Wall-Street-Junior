# Dual Liquidity Inventory System (DLI) 設計案

## 1. 基本コンセプト

株式やコモディティ、流動性プールの通貨ペアなどの各銘柄（Asset）に対して、「現金在庫（Currency Vault）」と「現物在庫（Asset Vault）」の2つを持つレンディングプールを割り当てます。

ユーザーのロング/ショートはこのプールから「在庫」を引き出すことで実行され、在庫の枯渇度合い（利用率）に応じて、**金利（ロング用コスト）**と**貸出料（ショート用コスト）**がリアルタイムに変動します。

### シーソー・メカニズム (The Seesaw Balance)

ユーザーのアイデアにある「ショートすることで比率が戻る（金利が下がる）」という挙動は、以下のフローで実現します。

1. **ロング実行時**:
* プールから**現金**を借りる → 市場で株を買う。
* **結果**: プールの「現金」が減る。「株」は変わらない。
* **影響**: 現金が不足するため、**買方金利が上昇**する。


2. **ショート実行時**:
* プールから**株**を借りる → 市場で売って**現金**を得る。
* **重要**: ショートで得た現金（売却代金）は、担保としてプールに戻される（＝現金の供給）。
* **結果**: プールの「株」が減る。「現金」が増える（回復する）。
* **影響**: 現金不足が解消され**買方金利は下落**するが、株不足により**貸出料が上昇**する。



これにより、「ロングが増えすぎるとショートが有利になり（金利受取が発生など）」、「ショートが増えすぎると貸出料が高騰して踏み上げ（スクイーズ）が起きる」という自律的なバランス調整が働きます。

---

## 2. 数理モデル (Interest Rate Model)

在庫の減少（需要過多）を金利に反映させるため、**利用率 (Utilization Rate)** に基づく「キンク（折れ線）モデル」を採用します。

### 定義

* $`U_{cash}`$ (現金利用率) = $`\frac{Borrowed\ Cash}{Total\ Cash}`$
* $`U_{asset}`$ (在庫利用率) = $`\frac{Borrowed\ Asset}{Total\ Asset}`$

### 金利計算式 (在庫が減るほど急激に高くなる)

通常時は低金利ですが、在庫が枯渇ライン（例: 80%利用）を超えると、指数関数的に金利が跳ね上がります。

* **徴収タイミング (Frequency)**: **2時間ごと**。毎日ログインしてポジションを確認させるための頻度設定です。
* **レート設定 (Rate Tuning)**:
    *   **基本レート (Base Rate)**: 日次 **0.05% ～ 0.1%**。
    *   **高騰時 (High Utilization)**: 在庫枯渇時は日次 **1.0% ～ 5.0%** まで上昇します（ショートスクイーズ発生時など）。
*   **UI表示**: 「年利 (APY)」ではなく、**「日次金利 (Daily Rate)」** や **「Borrow Fee: 0.05% / day」** と表示します。

* **ロング金利 (Borrow Rate)**: $`U_{cash}`$ が高いほど上昇。
* **貸出料 (Short Fee)**: $`U_{asset}`$ が高いほど上昇。

---

## 3. データベース設計 (Schema Update)

`init.sql` に、このプールを管理するテーブルを追加します。`liquidity_pools`（FX用）とは別に、信用取引専用の管理テーブルを作成します。

また、プレイヤーによる流動性提供（レンディング）を実現するため、各プレイヤーの持分（Shares）を管理するテーブル `margin_pool_providers` を追加し、`margin_pools` テーブルに総発行シェア数（`total_cash_shares`, `total_asset_shares`）を追加します。

---

## 4. トランザクション・フロー詳細

ユーザーが「5株」の注文を出した際のシステムの動きです。

### ケースA: 新規ロング (Buy 5 Stocks)

1. **在庫確認**: `margin_pools` の `(total_cash - borrowed_cash)` を確認。5株分の購入代金（例: 500 ARC）があるか？
2. **資金調達**:
* `borrowed_cash` を +500 ARC。
* プール内の現金利用率 $`U_{cash}`$ が上昇 → **ロング金利上昇**。


3. **市場執行**:
* 市場（Order Book）から5株を購入。
* ユーザーの `positions` テーブルに「数量: +5」を記録。


4. **商品管理**:
* 購入した5株はユーザー所有となるが、信用建玉の場合は「担保」として拘束されるため、概念上はプールの `total_assets` には影響しない。



### ケースB: 新規ショート (Sell 5 Stocks)

1. **在庫確認**: `margin_pools` の `(total_assets - borrowed_assets)` を確認。貸せる株が5株あるか？
2. **株調達**:
* `borrowed_assets` を +5 株。
* プール内の株利用率 $`U_{asset}`$ が上昇 → **貸出料（逆日歩）上昇**。


3. **市場執行**:
* 市場（Order Book）で5株を売却。売却代金（例: 500 ARC）を取得。


4. **資金還流 (Liquidity Injection)**:
* 売却代金 500 ARC は、ショートポジションの担保としてプール内に留保される。
* **ここがポイント**: これを「貸出可能現金」として扱う（Rehypothecation）。
* `total_cash`（または見かけ上の供給量）が増加するため、現金利用率 $`U_{cash}`$ が低下 → **ロング金利下落**。

---

## 5. ゲームプレイへの影響とメリット

この仕組みを導入することで、以下の戦略性が生まれます。

1. **「逆張り」インセンティブの発生**:
* ロングが殺到して金利が高騰している時、ショートを入れると「高い金利を払わずに済む」どころか、「ショートすることでプールに現金を供給した報酬（金利受取）」を得られるような設計も可能です。
2. **ショートスクイーズ（踏み上げ）の可視化**:
* `borrowed_assets` が `total_assets` に近づくと、貸出料が垂直に上昇します。これが「在庫切れ（Locate不可）」の状態となり、既存のショート勢は莫大な維持費を払うか、買い戻す（決済する）かの二択を迫られます。
3. **Botによる裁定取引**:
* 金利が下がりすぎた銘柄をロングし、上がりすぎた銘柄をショートするBot（Arbitrageur）を実装しやすくなり、市場のボラティリティが安定します。

---

## 6. 流動性提供システム (Lending System)

プレイヤーはプールに対して「現金」または「現物資産」を預け入れることで、流動性提供者（Lender）となり、借り手（Trader）が支払う金利の一部を収益として得ることができます。

### 6.1. シェアトークン・モデル (Share Token Model)

預け入れた資産の価値を追跡するために、DeFi（CompoundやAave）で採用されている「シェアトークン（cToken/aToken）」と同様のモデルを採用します。

*   **Shares (持分)**: プレイヤーがプールに預け入れた資産の割合を示す単位。
*   **Exchange Rate (交換レート)**: シェア1単位あたりの資産価値。
    *   $`Exchange\ Rate = \frac{Total\ Liquidity\ (Principal + Interest)}{Total\ Shares}`$

### 6.2. 利益還元の仕組み

1.  **金利収入の発生**:
    *   借り手がポジションを維持するために金利（Interest/Fee）を支払います。
    *   この金利はプールの `total_cash` または `total_assets` に加算されます。
2.  **シェア価値の上昇**:
    *   金利収入により、分母（`Total Shares`）が変わらないまま分子（`Total Liquidity`）が増加します。
    *   結果として `Exchange Rate` が上昇します。
3.  **引き出し時の利益確定**:
    *   プレイヤーが流動性を引き出す（Withdraw）際、預け入れ時よりも高いレートで換金されるため、差額が利益（金利収入）となります。

### 6.3. トランザクションフロー

#### デポジット (Deposit)
プレイヤーが 1,000 ARC をプールに預け入れる場合：
1.  現在の `Exchange Rate` を計算（初期値は 1.0）。
2.  `Issued Shares = 1,000 / Exchange Rate` を計算。
3.  プレイヤーの `margin_pool_providers` レコードに `Issued Shares` を加算。
4.  プールの `total_cash` に 1,000 を加算し、`total_cash_shares` に `Issued Shares` を加算。

#### ウィズドロー (Withdraw)
プレイヤーが保有するシェア全てを引き出す場合：
1.  現在の `Exchange Rate` を計算（金利収入により 1.05 に上昇していると仮定）。
2.  `Redeem Amount = Owned Shares * Exchange Rate` を計算。
3.  プレイヤーの `currency_balances` に `Redeem Amount` を加算。
4.  プールの `total_cash` から `Redeem Amount` を減算し、`total_cash_shares` から `Owned Shares` を減算。
