# Trader Rank & Progression System Specification

## 1. 概要 (Overview)

本システムは、プレイヤーの活動量（XP）に基づいて「トレーダーランク」を決定し、経済的な優位性を付与するプログレッションシステムです。
プレイヤーは「手数料削減」と「金利優遇」を目指して日々のミッションを遂行し、生態系の頂点（Leviathan）を目指します。


## 2. ランク定義 (Rank Definitions)

ランク名は「金融市場における捕食者・生態系」をモチーフにした5段階とします。
上位ランクほど、取引手数料と信用取引コストが大幅に削減されます。

### ランクマスタテーブル

| Rank ID | ランク名 (Predator) | 必要累積XP | Maker手数料 | Taker手数料 | 信用金利優遇 | 備考 |
| --- | --- | --- | --- | --- | --- | --- |
| **1** | **Shrimp** | 0 | 0.040% | 0.100% | なし | 初期状態。市場の養分。 |
| **2** | **Fish** | 200 | 0.020% | 0.075% | -5% | 一般大衆投資家。 |
| **3** | **Shark** | 1,000 | 0.010% | 0.050% | -10% | 獰猛なトレーダー。 |
| **4** | **Whale** | 3,000 | 0.000% | 0.025% | -20% | 市場を動かす大口。 |
| **5** | **Leviathan** | 5,000 | 0.000% | 0.000% | -50% | 伝説級の支配者。 |

* **信用金利優遇 (Interest Discount)**:
    * 信用取引（レバレッジ・空売り）にかかる日次コスト（Borrow Rate / Short Fee）に対して適用される割引率です。
    * 例: 日次金利が 0.1% の銘柄を「Leviathan」が取引する場合、コストは 0.05% になります。


## 3. XP獲得ロジック: デイリーアサインメント

ランクアップに必要なXPは、主に日々の「デイリーミッション（Daily Assignments）」から獲得します。
難易度別にペアで構成され、**「ペア完遂（セットボーナス）」**でのみXPが付与されます。

### ミッション構成 (2+2+2)

#### 1. Grade C: Shrimp Tasks (入門)

**ターゲット**: 初心者、ログイン勢、世界観を楽しみたい層
**目的**: UIの操作を覚える、市場を観察する
**報酬**: **5 XP** + 少額の資金

| ミッション名 | 達成条件 | 狙い・解説 |
| --- | --- | --- |
| **Window Shopper** | 異なる3つの銘柄の詳細画面（チャート）を開く。 | とにかく色々な銘柄を見てもらう。 |
| **First Bid** | 「指値（Limit）」注文を1回出す（約定しなくてもOK）。 | 成行だけでなく、板に注文を並べる操作を覚える。 |
| **News Reader** | ニュースフィードの詳細を3件開く。 | ニュースが価格変動のトリガーであることを意識させる。 |
| **Tourist** | 異なる2つの地域（例: ArcadiaとBoros）の銘柄を保有する。 | 地域分散（Geopolitical Diversification）の概念に触れる。 |
| **Penny Pincher** | 1株あたりの価格が 100 ARC 未満の銘柄を購入する。 | 低位株（Small Cap）への誘導。 |
| **Safety First** | 「債券（Bond）」または「短期証券（Bill）」を購入する。 | リスクオフ資産の存在を教える。 |

#### 2. Grade B: Shark Tasks (実務)

**ターゲット**: アクティブトレーダー、利益を追求する層
**目的**: テクニカル分析の実践、ボラティリティへの参加、特殊注文の利用
**報酬**: **25 XP**

| ミッション名 | 達成条件 | 狙い・解説 |
| --- | --- | --- |
| **Day Trader** | 同一銘柄を、購入してから（ゲーム内時間で）1日以内に売却する。 | 回転売買（デイトレード）の推奨。 |
| **Profit Taker** | 評価益が +5% を超えているポジションを利確（決済）する。 | 「利食い千人力」の実践。 |
| **Stop Loss** | 「逆指値（Stop）」注文を発注する。 | リスク管理（損切り設定）の習慣化。 |
| **Short Seller** | 信用売り（Short）ポジションを新規に建てる。 | 下落相場でも利益を出せることを体験させる。 |
| **Sector Rotation** | その日最も上昇しているセクターの銘柄を買い、下落しているセクターを売る。 | トレンドフォロー（順張り）の実践。 |
| **Buy The Dip** | 前日比 -3% 以上下落している銘柄を購入する。 | 逆張り（押し目買い）の実践。 |
| **Yield Hunter** | 配当利回り（または債券利回り）が 5% 以上の銘柄を保有する。 | インカムゲイン狙いの戦略。 |
| **Tech Lover** | ポートフォリオの50%以上を TECH セクターにする。 | 特定セクターへの集中投資リスクとリターンの体験。 |

#### 3. Grade A: Whale Tasks (上級)

**ターゲット**: ガチ勢、市場を動かす層
**目的**: 流動性供給、裁定取引、リスクテイク
**報酬**: **60 XP**

| ミッション名 | 達成条件 | 狙い・解説 |
| --- | --- | --- |
| **Market Maker** | 任意の銘柄の板（Order Book）に、BuyとSell両方の指値を同時に5分間維持する。 | スプレッドを提供し、市場の流動性を支える役割。 |
| **Liquidity King** | FXの流動性プールに、合計 10,000 ARC 相当以上の流動性を供給する。 | 為替市場の安定化への貢献。 |
| **Arbitrageur** | 指数（例: PSI10）と、その構成銘柄の両方を同日に取引する。 | 指数と現物の価格乖離（裁定機会）を探させる。 |
| **Big Ticket** | 1回の注文で 50,000 ARC 以上の約定を成立させる。 | 大口取引による「Market Impact（自身の注文で価格が動く感覚）」を体験。 |
| **News Reactor** | 「重要（Breaking）」タグのニュース着弾から30秒以内に、関連銘柄を取引する。 | 情報戦・反射神経の勝負。 |
| **Contrarian** | 市場全体のセンチメント（Fear & Greed）と逆のポジションを建てる。 | 大衆心理の逆を行く高度な心理戦。 |
| **Leverage Master** | レバレッジ 20倍以上のポジションを建て、マージンコールを受けずに8時間持ち越す。 | 証拠金維持率の精密な管理。 |
| **The Squeeze** | 貸出料（Short Fee）が高騰している銘柄でロングを入れる。 | ショートスクイーズ（踏み上げ相場）を意図的に狙う。 |


## 4. シーズン移行と「強くてニューゲーム」

シーズン（60日）終了時、全プレイヤーの資産はリセットされますが、**前シーズンの実績に応じて次シーズンの初期XPにボーナス**が付与されます。
これにより、上級者はスタートダッシュ（手数料優遇・金利優遇を持った状態）が可能になります。

### ボーナス付与ロジック

次シーズンの初期XPは、以下の2つの要素の合計値で決定されます。

#### A. ランク引継ぎボーナス (Legacy Rank Bonus)

前シーズン終了時点のランクに応じて、基礎XPを付与します。

* **Leviathan**: +500 XP
* **Whale**: +200 XP
* **Others**: 0 XP

#### B. ランキング入賞ボーナス (Leaderboard Bonus)

前シーズンの「総資産ランキング」上位者への追加報酬です。

* **Top 50**: +200 XP

#### 適用例

* 前シーズン「Leviathan」かつ「ランキング50位以内」のプレイヤー
    * 500 + 200 = **700 XP**


## 5. 計算・判定ロジック概要

### 5.1. 手数料・金利計算フロー

取引実行時および金利徴収バッチ処理時に、以下の計算を行います。

1. **ユーザー情報取得**: `users` テーブルから現在の `rank_id` を取得。
2. **マスタ参照**: `rank_master` から該当ランクの `fee_rate` と `interest_discount` を取得。
3. **コスト計算**:
    * **手数料**: `約定額 × fee_rate`
    * **金利**: `(建玉額 × 基本日次レート) × (1 - interest_discount)`
    * ※ Leviathanの場合、手数料は0、金利は半額となる。

### 5.2. ランクアップ判定フロー

XPが増加するアクション（ミッション達成、シーズン開始時のボーナス付与）が発生した瞬間に判定します。

1. **XP加算**: ユーザーの `current_xp` を更新。
2. **閾値チェック**: 現在のXPが、次のランクの `required_xp` を超えているか確認。
3. **昇格処理**:
    * 超えている場合、`rank_id` を更新。
    * クライアントへ通知（"Rank Up! You are now a Shark!"）。
    * 新しい手数料レートは即座に次回の注文から適用される。


## 6. UI/UX 要件

### プロファイル・ステータス表示

* **ランクアイコン**: プレイヤー名の横に、ランクに応じた魚/海洋生物のアイコンを表示。
* **XPバー**: 次のランクまでの進捗をプログレスバーで可視化。

### ミッション画面

* 3つのグレード（Shrimp/Shark/Whale）を並列表示。
* 「あと1つでセットボーナス獲得」を強調表示し、行動を促す。

### シーズンリザルト画面

* シーズン終了時、次シーズンの「初期ランク」と「スタートダッシュボーナス」を演出として表示。
* 「あなたの実績により、来シーズンは **Shark** として優遇された状態で開始できます」等のメッセージを表示。
